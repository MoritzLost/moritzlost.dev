---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import TableOfContents from '@components/TableOfContents.astro';
import Emoji from '@components/Emoji.astro';
import Time from '@components/Time.astro';
import { sortArticlesByDatePrefix } from '@utils/sort-content';
import { render } from 'astro:content';

interface Props {
    article: CollectionEntry<'articles'>;
    articles: Array<CollectionEntry<'articles'>>;
}

export async function getStaticPaths() {
    const articles = await getCollection('articles');
    const articlesSorted = sortArticlesByDatePrefix(articles);
    return articles.map(article => ({
        params: { article: article.id },
        props: { article, articles: articlesSorted },
    }));
}

// const { article, articles } = Astro.props;
const { article } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(article);

const fileHistoryUrl = `https://github.com/MoritzLost/moritzlost.dev/commits/main/${article.filePath}`;
const editUrl = `https://github.com/MoritzLost/moritzlost.dev/edit/main/${article.filePath}`;

const publishedDate = new Date(remarkPluginFrontmatter.publishedDate);
const hasRevisionHistory = remarkPluginFrontmatter.revisionHistory.length > 1;
const lastRevision = hasRevisionHistory && remarkPluginFrontmatter.revisionHistory[0];
---

<BaseLayout title={article.data.title}>
    <section class="article-layout" aria-labelledby="article-heading">
        <div class="article-layout__header">
            <h1 id="article-heading">{article.data.title}</h1>
            <p class="subline-author">
                â€”by Moritz Lâ€™Hoest
                <span class="subline-divider" aria-hidden="true">Â·</span>
                <Time date={publishedDate} />
            </p>
        </div>

        <aside class="article-layout__aside">
            <TableOfContents {headings} />
        </aside>

        <div class="article-layout__content stack">
            <Content />

            <footer class="article-footer stack">
                <hr />
                {
                    article.data.disclaimerNoAI && (
                        <p class="no-ai-disclaimer">
                            This article was written by a human without the involvement of AI.
                        </p>
                    )
                }

                <p class="article-meta">
                    <span><Emoji emoji="ðŸ’¡" /> Published on <Time date={publishedDate} /></span>
                    {
                        lastRevision && (
                            <span>
                                <Emoji emoji="âœï¸" /> Last edited on <Time date={new Date(lastRevision.date)} />
                            </span>
                        )
                    }
                    {
                        hasRevisionHistory && (
                            <span>
                                <Emoji emoji="ðŸ—‚ï¸" /> <a href={fileHistoryUrl}>View revision history</a>
                            </span>
                        )
                    }
                    <span><Emoji emoji="ðŸ’¡" /> <a href={editUrl}>Suggest an edit</a></span>
                </p>
            </footer>
        </div>
    </section>
</BaseLayout>

<style lang="postcss">
    .article-layout {
        --sidebar-width: 20rem;
        --article-min-width: 45ch;
        --article-max-width: 65ch;

        padding-inline: var(--container-padding-x);

        display: grid;
        column-gap: 5rem;
        row-gap: var(--stack-gap-headings);
        justify-content: center;
        grid-template-columns: minmax(0, var(--article-max-width));
        grid-template-areas: 'header' 'aside' 'content';

        > .article-layout__header {
            grid-area: header;
        }

        > .article-layout__aside {
            grid-area: aside;
        }

        > .article-layout__content {
            grid-area: content;
        }
    }

    @media (min-width: 70rem) {
        .article-layout {
            grid-template-columns: minmax(var(--article-min-width), var(--article-max-width)) var(--sidebar-width);
            grid-template-areas: 'header aside' 'content aside';

        }

        .article-layout__aside {
            align-self: start;
            position: sticky;
            top: 3rem;
        }
    }

    @media (min-width: 85rem) {
        .article-layout {
            grid-template-columns: minmax(0, var(--sidebar-width)) var(--article-max-width) var(--sidebar-width);
            grid-template-areas: '. header aside' '. content aside';
        }
    }

    .subline-author {
        --stack-gap: 0;
        font-size: var(--font-size-1);
        font-family: var(--headings-font-family);
        font-weight: 500;
    }

    .subline-divider {
        padding-inline: .5rem;
    }

    .article-footer {
        margin-top: 5rem;
        font-size: var(--font-size--1);
    }

    .no-ai-disclaimer {
        font-style: italic;
    }

    .article-meta {
        > * {
            display: block;
        }
        > * + * {
            margin-top: .5rem;
        }
    }

    .article-link {
        display: grid;
    }
</style>
